<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tu Quiniela</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; align-items: flex-start; }
    .container { max-width: 600px; width: 100%; background: #fff; margin: 40px 20px; padding: 30px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    h1 { text-align: center; margin-bottom: 20px; color: #333; }
    label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
    select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    button { margin-top: 25px; width: 100%; padding: 12px; font-size: 16px; background-color: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .match { margin-top: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    /* EL PLENO AL 15 EMPIEZA OCULTO */
    #extra-match {
      display: none; 
      margin-top: 20px; padding: 15px;
      background-color: #fff3cd; border: 2px solid #ffecb5; border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tu Quiniela</h1>
    <form id="quinielaForm">
      <label for="nombre">Selecciona tu nombre:</label>
      <select id="nombre" name="nombre" required>
        <option value="">Cargando nombres...</option>
      </select>

      <div id="partidos"></div>
      
      <!-- Bloque din√°mico para el ID 15 (Betis - Sevilla) -->
      <div id="extra-match">
        <label id="labelP15" for="p15"><strong>PARTIDO 15:</strong></label>
        <select name="p15" id="p15">
          <option value="">Elige Goles (0, 1, 2, M)</option>
          <option value="1-0">1-0</option>
          <option value="0-1">0-1</option>
          <option value="1-1">1-1</option>
          <option value="M-M">M-M</option>
          <!-- Puedes poner aqu√≠ las opciones que prefieras para el pleno -->
        </select>
      </div>

      <button type="submit">Enviar Pron√≥stico</button>
      <button type="button" onclick="location.href='index.html'">Inicio</button>
     </form>
  </div>

  <script>
    const API_URL = "/api";
    let USUARIO_ESPECIAL = "";

    async function inicializarApp() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        
        USUARIO_ESPECIAL = data.usuarioEspecial;

        // 1. Cargar Partidos (Solo del 1 al 14)
        const partidosDiv = document.getElementById("partidos");
        const listaPartidos = data.partidos.slice(1, 15); // Toma de la fila 2 a la 15 (IDs 1-14)
        
        listaPartidos.forEach((p, index) => {
          const div = document.createElement("div");
          div.className = "match";
          div.innerHTML = `<label>Partido ${index+1}: ${p[1]} vs ${p[2]}</label>
            <select name="p${index+1}" required>
              <option value="">Elige</option><option value="1">1</option><option value="X">X</option><option value="2">2</option>
            </select>`;
          partidosDiv.appendChild(div);
        });

        // 2. Configurar Partido 15 (Fila 16 del Excel)
        if (data.datosPartido15) {
          document.getElementById("labelP15").innerHTML = `<strong>üî• PLENO AL 15: ${data.datosPartido15.local} vs ${data.datosPartido15.visitante}</strong>`;
        }

        // 3. Cargar Nombres
        const selectNombres = document.getElementById("nombre");
        selectNombres.innerHTML = '<option value="">Selecciona tu nombre</option>';
        const nombresUnicos = [...new Set(data.pronosticos.slice(1).map(f => f[0]))].filter(n => n);
        
        nombresUnicos.forEach(n => {
          const opt = document.createElement("option");
          opt.value = n;
          opt.textContent = (n === USUARIO_ESPECIAL) ? n + " ‚≠ê (Te toca el 15)" : n;
          selectNombres.appendChild(opt);
        });

      } catch (e) { alert("Error al cargar datos"); }
    }

    // L√≥gica para mostrar/ocultar el Pleno 15 seg√∫n el nombre
    document.getElementById("nombre").addEventListener("change", function() {
      const extraDiv = document.getElementById("extra-match");
      const p15Select = document.getElementById("p15");
      
      if (this.value !== "" && this.value === USUARIO_ESPECIAL) {
        extraDiv.style.display = "block";
        p15Select.required = true;
      } else {
        extraDiv.style.display = "none";
        p15Select.required = false;
        p15Select.value = "";
      }
    });

    document.getElementById("quinielaForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = { nombre: formData.get("nombre") };

      for (let i = 1; i <= 14; i++) { data["p" + i] = formData.get("p" + i); }
      data["p15"] = formData.get("p15") || ""; // Se env√≠a a la columna P del excel

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.resultado === "ok") {
          alert("‚úÖ Enviado.");
          location.reload();
        }
      } catch (error) { alert("Error al enviar"); }
    });

    inicializarApp();
  </script>
</body>
</html>
